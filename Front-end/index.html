<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Egzersiz Sınıflandırma • Frontend</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --muted: #9ca3af;
            --text: #e5e7eb;
            --primary: #22c55e;
            --danger: #ef4444;
            --border: #1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }
        .layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            padding: 20px;
            background: var(--panel);
            border-right: 1px solid var(--border);
        }
        .sidebar h2 { margin: 0 0 16px; font-size: 18px; }
        .model-list { display: grid; gap: 10px; }
        .model-item { display: flex; align-items: center; gap: 10px; }
        .badge { font-size: 12px; color: var(--muted); }

        .main {
            padding: 24px;
        }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }
        .api-input {
            display: flex; align-items: center; gap: 8px;
            color: var(--muted); font-size: 14px;
        }
        .api-input input {
            width: 340px;
            padding: 8px 10px;
            background: #0b1220;
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .dropzone {
            display: grid; place-items: center;
            border: 2px dashed var(--border);
            border-radius: 12px; height: 240px;
            color: var(--muted);
            transition: border-color .15s ease, color .15s ease;
            cursor: pointer;
        }
        .dropzone.dragover { border-color: var(--primary); color: var(--text); }
        .actions { display: flex; gap: 10px; margin-top: 12px; }
        button {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #0b1220;
            color: var(--text);
            cursor: pointer;
        }
        button.primary { background: var(--primary); border-color: #16a34a; color: #052e14; }
        button:disabled { opacity: .6; cursor: not-allowed; }

        video { width: 100%; border-radius: 10px; background: #000; }

        .result-row { display: grid; grid-template-columns: 180px 1fr; gap: 10px; margin: 8px 0; }
        .label { color: var(--muted); }
        .value { color: var(--text); font-weight: 600; }

        .status { margin-top: 10px; font-size: 14px; color: var(--muted); }
        .status.error { color: var(--danger); }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <h2>Model Seçimi</h2>
            <div class="model-list" id="modelList">
                <label class="model-item"><input type="radio" name="model" value="tcn" checked> <span>TCN</span> <span class="badge">one_hot</span></label>
                <label class="model-item"><input type="radio" name="model" value="bilstm"> <span>BiLSTM</span> <span class="badge">cross_entropy</span></label>
                <label class="model-item"><input type="radio" name="model" value="tft_1"> <span>TFT V1</span> <span class="badge">cross_entropy</span></label>
                <label class="model-item"><input type="radio" name="model" value="tft_2"> <span>TFT V2</span> <span class="badge">cross_entropy</span></label>
            </div>
        </aside>

        <main class="main">
            <div class="topbar">
                <h1 style="margin:0; font-size:20px;">Egzersiz Sınıflandırma</h1>
                <div class="api-input">
                    <span>API:</span>
                    <input id="apiBase" type="text" value="http://localhost:5001" />
                </div>
            </div>

            <div class="grid">
                <section class="card">
                    <h3 style="margin:0 0 10px;">Video Yükle</h3>
                    <div id="dropzone" class="dropzone">
                        <div>
                            <div style="text-align:center;">
                                Dosyayı buraya sürükleyin<br/> veya tıklayın
                            </div>
                            <div style="text-align:center; margin-top:8px;">
                                <small>MP4 / WebM önerilir</small>
                            </div>
                        </div>
                    </div>
                    <input id="fileInput" type="file" accept="video/*" style="display:none;" />
                    <div class="actions">
                        <button id="predictBtn" class="primary">Tahmin Yap</button>
                        <button id="resetBtn">Temizle</button>
                    </div>
                    <div id="status" class="status"></div>
                </section>

                <section class="card">
                    <h3 style="margin:0 0 10px;">Önizleme</h3>
                    <video id="preview" controls></video>
                </section>
            </div>

            <section class="card" style="margin-top:16px;">
                <h3 style="margin:0 0 10px;">Sonuç</h3>
                <div id="result">
                    <div class="result-row"><div class="label">Seçilen Model</div><div class="value" id="rModel">–</div></div>
                    <div class="result-row"><div class="label">Tahmin ID</div><div class="value" id="rId">–</div></div>
                    <div class="result-row"><div class="label">Tahmin Adı</div><div class="value" id="rName">–</div></div>
                    <div class="result-row"><div class="label">Güven</div><div class="value" id="rConf">–</div></div>
                </div>
            </section>

            <section class="card" style="margin-top:16px;">
                <h3 style="margin:0 0 10px;">Geçmiş Tahminler</h3>
                <div id="history">
                    <div class="status" id="historyStatus">Henüz kayıt yok.</div>
                    <div id="historyList"></div>
                    <div class="actions">
                        <button id="toggleHistoryBtn">Geçmişi Göster</button>
                        <button id="clearHistoryBtn">Geçmişi Temizle</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const predictBtn = document.getElementById('predictBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statusEl = document.getElementById('status');
        const apiBaseEl = document.getElementById('apiBase');

        const rModel = document.getElementById('rModel');
        const rId = document.getElementById('rId');
        const rName = document.getElementById('rName');
        const rConf = document.getElementById('rConf');

        // History elements
        const historyStatusEl = document.getElementById('historyStatus');
        const historyListEl = document.getElementById('historyList');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
        const history = [];
        let historyCollapsed = true;

        let selectedFile = null;
        let selectedModel = 'tcn';

        document.getElementById('modelList').addEventListener('change', (e) => {
            if (e.target && e.target.name === 'model') selectedModel = e.target.value;
        });

        const clearResult = () => {
            rModel.textContent = '–';
            rId.textContent = '–';
            rName.textContent = '–';
            rConf.textContent = '–';
        };

        const setStatus = (msg, isError = false) => {
            statusEl.textContent = msg || '';
            statusEl.className = 'status' + (isError ? ' error' : '');
        };

        const setPreview = (file) => {
            if (!file) { preview.removeAttribute('src'); preview.load(); return; }
            const url = URL.createObjectURL(file);
            preview.src = url;
            preview.load();
        };

        const chooseFile = () => fileInput.click();

        dropzone.addEventListener('click', chooseFile);
        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const file = e.dataTransfer.files?.[0];
            if (file) { selectedFile = file; setPreview(file); setStatus('Video seçildi: ' + (file.name || 'video')); }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (file) { selectedFile = file; setPreview(file); setStatus('Video seçildi: ' + (file.name || 'video')); }
        });

        resetBtn.addEventListener('click', () => {
            selectedFile = null; fileInput.value = '';
            setPreview(null); clearResult(); setStatus('');
        });

        const renderHistory = () => {
            if (!history.length) {
                historyStatusEl.textContent = 'Henüz kayıt yok.';
                historyListEl.innerHTML = '';
                return;
            }
            historyStatusEl.textContent = '';
            historyListEl.innerHTML = history
                .map((h, i) => `<div class="result-row"><div class="label">${String(i+1).padStart(2,'0')}</div><div class="value">${h}</div></div>`)
                .join('');
        };

        clearHistoryBtn.addEventListener('click', () => { history.length = 0; renderHistory(); });
        const updateHistoryVisibility = () => {
            const hidden = historyCollapsed;
            historyListEl.classList.toggle('hidden', hidden);
            historyStatusEl.classList.toggle('hidden', hidden);
            toggleHistoryBtn.textContent = hidden ? 'Geçmişi Göster' : 'Geçmişi Gizle';
        };
        toggleHistoryBtn.addEventListener('click', () => { historyCollapsed = !historyCollapsed; updateHistoryVisibility(); });

        predictBtn.addEventListener('click', async () => {
            if (!selectedFile) { setStatus('Lütfen bir video seçin.', true); return; }

            const apiBase = apiBaseEl.value.trim().replace(/\/$/, '');
            const url = apiBase + '/predict';

            const fd = new FormData();
            fd.append('video', selectedFile);
            fd.append('model', selectedModel);

            predictBtn.disabled = true;
            setStatus('Yükleniyor ve tahmin yapılıyor…');
            clearResult();

            try {
                const res = await fetch(url, { method: 'POST', body: fd });
                const data = await res.json().catch(() => ({}));

                predictBtn.disabled = false;

                if (!res.ok) {
                    const avail = Array.isArray(data.available_models) ? (' (Mevcut: ' + data.available_models.join(', ') + ')') : '';
                    setStatus((data.error || 'İstek başarısız') + avail, true);
                    return;
                }

                const { selected_model, prediction_id, prediction_name, confidence } = data;
                rModel.textContent = selected_model ?? selectedModel;
                rId.textContent = prediction_id ?? '–';
                rName.textContent = prediction_name ?? '–';
                const confNum = typeof confidence === 'number' ? confidence : parseFloat(confidence);
                rConf.textContent = Number.isFinite(confNum) ? (confNum * 100).toFixed(1) + '%' : (confidence ?? '–');
                setStatus('Tahmin tamamlandı.');

                // Append to history as a plain string: "model : tahmin • video"
                const fileName = selectedFile?.name || 'video';
                const modelText = selected_model ?? selectedModel;
                const predText = prediction_name ?? String(prediction_id ?? '–');
                const percentText = Number.isFinite(confNum) ? (confNum * 100).toFixed(1) + '%' : '–';
                const entry = `${modelText} : ${predText} • ${fileName} • ${percentText}`;
                history.push(entry);
                renderHistory();
                updateHistoryVisibility();
            } catch (err) {
                predictBtn.disabled = false;
                setStatus('Ağ hatası: ' + (err?.message || err), true);
            }
        });

        // Initial render for history
        renderHistory();
        updateHistoryVisibility();
    </script>
</body>
</html>
